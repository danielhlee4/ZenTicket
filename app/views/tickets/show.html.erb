<div class="container ticket-show-max-width">
  <h1 class="my-4"><%= @ticket.user.email %>'s Ticket Details</h1>

  <div class="card mb-4">
    <%= render_flash %>
    <div class="card-header">
      Ticket Information
    </div>
    <div class="card-body">
      <h5 class="card-title"><%= @ticket.title %></h5>
      <p class="card-text"><strong>Description:</strong> <%= @ticket.description %></p>
      <% if current_user.admin? %>
        <p class="card-text"><strong>Priority Level:</strong> <%= @ticket.priority_level %></p>
        <p><strong>Internal Note:</strong> <%= @ticket.internal_note %></p>
      <% end %>
      <p class="card-text"><strong>Status:</strong> <%= @ticket.status %></p>
      <% if @ticket.resolution_details.present? %>
        <p class="card-text"><strong>Resolution Details:</strong> <%= @ticket.resolution_details %></p>
      <% end %>
    </div>
  </div>

  <%= link_to 'Edit', edit_ticket_path(@ticket), class: 'btn btn-info' %>
  <%= link_to 'Delete', @ticket, method: :delete, data: { confirm: 'Are you sure you want to delete this ticket?' }, class: 'btn btn-warning' %>
  <%= link_to 'Return to Dashboard', tickets_path, class: 'btn btn-secondary' %>

  <h2>Comments</h2>

  <% if current_user == @ticket.user || current_user.admin? %>
    <%= form_with(model: [@ticket, Comment.new], local: true) do |form| %>
      <div class="mb-3">
        <%= form.label :content %>
        <%= form.text_area :content, class: 'form-control', rows: 3 %>
      </div>
      <%= form.submit 'Add Comment', class: 'btn btn-primary' %>
    <% end %>
  <% else %>
    <p>You are not authorized to comment on this ticket.</p>
  <% end %>

  <ul class="list-unstyled mt-4">
    <% @comments.each do |comment| %>
      <li class="mb-3">
        <div class="card">
          <div class="card-header">
            <strong><%= comment.user&.email || 'Unknown User' %></strong>
            <span class="float-end"><%= comment.created_at.strftime("%B %d, %Y %H:%M") %></span>
          </div>
          <div class="card-body">
            <p class="card-text"><%= comment.content %></p>
          </div>
        </div>
      </li>
    <% end %>
  </ul>
</div>
